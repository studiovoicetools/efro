#!/usr/bin/env node
/**
 * ğŸ” EFRO Render Pre-Flight-Check
 * PrÃ¼ft Node-Version, Config-Dateien, TGZ-Pakete und CSS-AbhÃ¤ngigkeiten
 * bevor der Build startet.
 */

import { execSync } from "child_process";
import { existsSync, writeFileSync, unlinkSync, readdirSync } from "fs";

console.log("ğŸš¦ EFRO Pre-Flight-Check gestartet ...");
console.log("ğŸ§© Node-Version:", process.version);

//
// 1ï¸âƒ£ Node-Version prÃ¼fen
//
const requiredMajor = 20;
const currentMajor = parseInt(process.version.split(".")[0].replace("v", ""), 10);
if (currentMajor !== requiredMajor) {
  console.warn(`âš ï¸  Node ${currentMajor}.x erkannt â€” erwartet wird ${requiredMajor}.x!`);
  console.warn("   Render wird zwar fortgesetzt, kann aber Warnungen zeigen.");
}

//
// 2ï¸âƒ£ mascotbot-SDK prÃ¼fen
//
if (existsSync("./mascotbot-sdk-react-0.1.6.tgz")) {
  console.log("âœ… mascotbot-SDK vorhanden");
} else {
  console.error("âŒ mascotbot-SDK fehlt im Projekt-Root!");
  process.exitCode = 1;
}

//
// 3ï¸âƒ£ PostCSS-Konfiguration prÃ¼fen
//
["postcss.config.js", "postcss.config.mjs"].forEach((file) => {
  if (existsSync(file)) {
    console.log(`âš™ï¸  Entferne alte Datei: ${file}`);
    unlinkSync(file);
  }
});

if (!existsSync("postcss.config.cjs")) {
  console.log("ğŸ§© Erstelle neue postcss.config.cjs ...");
  writeFileSync(
    "postcss.config.cjs",
    `// postcss.config.cjs (auto-generated by EFRO)
module.exports = {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
};
`
  );
} else {
  console.log("âœ… postcss.config.cjs vorhanden");
}

//
// 4ï¸âƒ£ CSS-AbhÃ¤ngigkeiten prÃ¼fen
//
["tailwindcss", "postcss", "autoprefixer"].forEach((pkg) => {
  try {
    execSync(`npm list ${pkg}`, { stdio: "ignore" });
    console.log(`âœ… ${pkg} installiert`);
  } catch {
    console.log(`ğŸ”§ Installiere ${pkg} ...`);
    execSync(`npm install -D ${pkg}`, { stdio: "inherit" });
  }
});

//
// 5ï¸âƒ£ Ãœbersicht ausgeben
//
console.log("----------------------------");
console.log("ğŸ“‚ Projekt-Root-Inhalt:");
for (const f of readdirSync(".")) console.log("  -", f);
console.log("----------------------------");
console.log("âœ… Pre-Flight-Check abgeschlossen â€” bereit fÃ¼r Render-Build");
